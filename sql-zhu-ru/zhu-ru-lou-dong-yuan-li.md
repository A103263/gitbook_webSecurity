# 注入漏洞原理

## 注入

什么是注入漏洞

 注入攻击的本质，Web应用程序没有过滤用户输入，直接把用户输入的恶意数据当做代码执行。

造成注入的两个必须的条件

* 用户能控制输入
* 原本程序要执行的代码，拼接了用户输入的数据

## 注入的类型

#### SQL注入

攻击者把SQL命令插入到Web表单的输入域或页面请求的查询字符串，欺骗数据库服务器执行恶意的SQL命令 

#### 命令注入：

后端未过滤掉恶意数据，代码当做系统命令执行。 

#### 代码注入：

一般出现在不安全的使用某些函数 

* 文件包含 
* 反序列化漏洞 

#### LDAP注入

 LDAP（轻量级目录访问协议），用于访问网络中的目录服务，常用在Active Directory，企业管理目录。

 用户提交的输入不经验证插入LDAP搜索过滤器中，攻击者通过提交专门设计的输入修改过滤器的结构，以检素数据或执行未授权操作。

#### XML注入

* XXE漏洞：引用外部实体时，通过构造恶意内容，导致读取任意文件、执行系统命令、探测内网端口、攻击内网网站等危害。 
* XPath注入：与SQL注入类似，XPath解析器本身对URL、表单中提交的代码内容未作严格限制，导致恶意代码可以直接解析执行 
* XQuery注入 

#### JSON注入：

轻量级的数据交换格式，主要利用特殊字符注入JSON中，造成解析失败 

#### JSONP注入：

回调函数未作严格的检测和过滤

## SQL注入

> 攻击者利用Web应用程序对用户输入验证上的疏忽，在输入的数据中包含对某些数据库系统有特殊意义的符号或命令，让攻击者有机会直接对后台数据库系统下达指令，进而实现对后台数据库乃至整个应用系统的入侵。

![&#x6CE8;&#x5165;&#x8FC7;&#x7A0B;](../.gitbook/assets/image%20%2890%29.png)

### SQl注入带来的危害

* 绕过登录验证：使用万能密码登录网站后台等。 or 1=1
* 获取敏感数据：获取网站管理员帐号、密码等。
* 文件系统操作：列目录，读取、写入文件等。
* 注册表操作：读取、写入、删除注册表等。 
* 执行系统命令：远程执行命令。

判断一个HTTP请求是否存在SQL注入的方式：

* 经典：and 1=1   l   and 2&gt;1     \|    or 1=1    \|   or   1&lt;1
* 数据库函数：and sleep\(4\)=1 I and length\(user\(\)\)&gt;3
* 特殊符号：单引号（’）双引号（”）

### 注入的分类

#### 数字型注入

* 输入的参数为整数，如ID、年龄、页码等，如果存在注入型漏洞，则为数字型注入

```text
http://www.testweb.com/user.php？id=8
```

存在数字型注入测试方法

![&#x6570;&#x5B57;&#x578B;&#x6CE8;&#x5165;&#x6D4B;&#x8BD5;&#x65B9;&#x6CD5;](../.gitbook/assets/image%20%2897%29.png)

#### 字符型注入

* 输入的参数为字符串 
* 与数组型注入的区别在于：字符型注入一般要使用单引号来闭合

存在字符型注入测试方法

![](../.gitbook/assets/image%20%2838%29.png)

#### 搜索型注入

这类注入主要是指在进行数据搜索时没过滤搜索参数 

一般在链接地址中有“keyword=关键字”，有的不显示的链接地址，而是直接通过搜索框表单提交。 此类注入点提交的SQL语句，其原形大致为： 

```sql
select * from 表名 where 字段 like '%关键字%';
```

_当我们提交注入参数为_

```sql
keyword= ' and [查询条件] and '%' = '
```

_则向数据库提交的SQL语句为：_ 

```sql
select * from 表名 where 字段 like '%' and [查询条件] and '%'='%'
```

### 造成注入的原因

#### 动态字符串构建引起

* 不正确的处理转义字符（宽字节注入） 
* 不正确的处理类型（报错泄露信息） 
* 不正确的处理联合查询 
* 不正确的处理错误（报错泄露信息） 
* 不正确的处理多次提交（二次注入）

#### 后台存在的问题： 

* 后台无过滤或者编码用户数据
* 数据库可以拼接用户传递的恶意代码 

#### 错误处理不当：

* 详细的内部错误消息显示给用户或攻击者 
* 错误信息可以直接给攻击者提供下一步攻击帮助

#### 不安全的数据库配置： 

默认账户： 

* SQL Server“sa"作为数据库系统管理员账户
* MySQL使用“root”和“anonymous”用户账户
* Oracle则在创建数据库时通常默认会创建SYS、SYSTEMS DBSNMP和OUTLN账户

权限：

 问题：系统和数据库管理员在安装数据库服务器时允许以root SYSTEM或Administrator特权系统用户账户身份执行操作。 

正确方法：应该始终以普通用户身份运行服务器上的服务，降低用户权限，将用户权限只限于本服务

### 手工注入的过程

（1）判断是否存在注入点；   
（2）判断字段长度；  
（3）判断字段回显位置；   
（4）判断数据库信息；   
（5）查找数据库名；  
（6）查找数据库表；   
（7）查找数据库表中所有字段以及字段值；   
（8）猜解账号密码；   
（9）登陆管理员后台。

### 寻找sql注入点

#### GET方法 

GET是一种请求服务器的HTTP方法。 使用该方法时，信息包含在URL中。点击一个链接时，一般会使用该方法。 

GET请求方法，格式： ?text =valuel&cat=value2&num=value3... 

修改方法： 

* 浏览器的导航栏中直接修改即可操纵这些参数。
* HackBar插件

## 自动化辅助工具

（1）sQL注入工具：

* Sqlmap
* Havij
* Sqlid 

（2）ASP，JSP注入工具：

* NBS1
* 阿D注入软件
* 明小子注入软件

（3）PHP注入工具： 

* 穿山甲注入软件
* 海阳顶端注入软件

其他常用注入工具

BSOL Hacker由Portcullis Labs开发，BSQL Hacker是一种自动化SQL注入框架，支持SQL盲注，定时盲注，深度盲注和错误识别盲注。

![](../.gitbook/assets/image%20%289%29.png)

The Mole 是一个开源工具，能够绕过一些使用普通过滤规则的IPS/IDS系统。通过Union和Boolean查询技术，Mole能够通过一个脆弱的URL或网站的一串字符就能侦查和实施注入。Mole的命令行工具支持攻击MySQL、SQL Server、Postgres和Oracle数据库。

![](../.gitbook/assets/image%20%2835%29.png)

Pangolin      与web安全漏洞扫描器JSky工具出自同一家公司——NOSEC，Pangolin是一个完整的SQL注入测试工具，有一个用户友好的GUI，能够攻击几乎市场上所有的数据库。 Pangolin通常被白帽社区用作渗透测试工具。

![](../.gitbook/assets/image%20%286%29.png)

Sqlmap号称自动化SQL注入和数据库接管工具，Sqlmap是开源工具，支持使用五种SQL注入技术攻击数据库，如果用户拥有DBMS账户、IP地址端口和数据库名称，则可以实施直接攻击。可通过内置的字典攻击用户名密码哈希值。

Havij Havij是在全球黑帽中非常流行的一个工具，由伊朗开发者开发，Havij在波斯语里是胡萝卜的意思（编者：暗指男根）。Havij可攻击MySQL、Oracle、PostgreSQL、MS Access和Sybase，攻击成功率号称有95%。

Safe3 SQL Injector是简单易用的自动化注入工具，可以自动侦测SQL注入漏洞并进行攻击，直至最后接管数据库。Safe3 SQL 还能自动识别数据库类型，并选择最佳的SQL注入方法。

![](../.gitbook/assets/image%20%2852%29.png)

